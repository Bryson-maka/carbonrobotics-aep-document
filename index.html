<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Engineering & Performance Team Scope</title>
    <style>
        /* Color palette from Carbon Robotics UI */
        :root {
            /* Primary accent (top nav bar) */
            --color-accent:        #A9421F;   /* rgb(169, 66, 31) */
            /* Accent hover state */
            --color-accent-hover:  #87422D;   /* rgb(135, 66, 45) */
            
            /* Dark primary background */
            --color-bg-primary:    #111518;   /* rgb(17, 21, 24) */
            /* Sidebar & table rows */
            --color-bg-sidebar:    #323F48;   /* rgb(50, 63, 72) */
            /* Surface / panel headers */
            --color-bg-surface:    #52525B;   /* rgb(82, 82, 91) */
            
            /* Text colors */
            --color-text-primary:  #FFFFFF;
            --color-text-secondary:#C6C7C8;   /* rgb(198,199,200) */
            
            /* Borders & muted elements */
            --color-border:        #3C3C3C;   /* rgb(60,60,60) */
            
            /* Progress indicators */
            --color-progress-red:    #dc3545;
            --color-progress-orange: #fd7e14;
            --color-progress-yellow: #ffc107;
            --color-progress-green:  #28a745;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--color-text-primary);
            background: var(--color-bg-primary);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--color-bg-sidebar);
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-hover) 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .header .meta {
            display: flex;
            justify-content: center;
            gap: 30px;
            font-size: 0.9em;
            opacity: 0.8;
        }

        .controls {
            background: var(--color-bg-surface);
            padding: 15px 40px;
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .controls-left {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .controls-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .edit-toggle {
            background: var(--color-accent);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s ease;
        }

        .edit-toggle:hover {
            background: var(--color-accent-hover);
        }

        .edit-toggle.active {
            background: #28a745;
        }

        .save-btn, .export-btn, .import-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            display: none;
        }

        .save-btn:hover, .export-btn:hover, .import-btn:hover {
            background: #218838;
        }

        .import-file {
            display: none;
        }

        .executive-summary {
            padding: 40px;
            background: var(--color-bg-surface);
            border-bottom: 1px solid var(--color-border);
            color: var(--color-text-primary);
        }

        .executive-summary h2 {
            color: var(--color-text-primary);
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .executive-summary p {
            color: var(--color-text-secondary);
        }

        .mission-box {
            background: rgba(169, 66, 31, 0.1);
            padding: 25px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 5px solid var(--color-accent);
            color: var(--color-text-primary);
        }

        .mission-box strong {
            color: var(--color-accent);
        }

        .accordion {
            padding: 0 40px 40px 40px;
        }

        .accordion-item {
            margin-bottom: 15px;
            border: 1px solid var(--color-border);
            border-radius: 10px;
            overflow: hidden;
            transition: all 0.3s ease;
            background: var(--color-bg-surface);
        }

        .accordion-item:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .accordion-header {
            background: var(--color-bg-surface);
            padding: 20px 25px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            border: none;
            width: 100%;
            text-align: left;
            font-size: 1.1em;
            font-weight: 600;
            color: var(--color-text-primary);
            position: relative;
        }

        .accordion-header:hover {
            background: rgba(169, 66, 31, 0.1);
        }

        .accordion-header.active {
            background: var(--color-accent);
            color: white;
        }

        .accordion-icon {
            font-size: 1.2em;
            transition: transform 0.3s ease;
        }

        .accordion-header.active .accordion-icon {
            transform: rotate(180deg);
        }

        /* Progress indicator */
        .progress-indicator {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 5px;
            transition: background-color 0.3s ease;
        }

        .progress-0 { background-color: var(--color-progress-red); }
        .progress-25 { background-color: var(--color-progress-orange); }
        .progress-50 { background-color: var(--color-progress-yellow); }
        .progress-75 { background-color: var(--color-progress-yellow); }
        .progress-100 { background-color: var(--color-progress-green); }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
            background: var(--color-bg-sidebar);
        }

        .accordion-content.active {
            max-height: none;
        }

        .accordion-body {
            padding: 25px;
        }

        .subsection {
            margin-bottom: 25px;
        }

        .subsection h4 {
            color: var(--color-text-primary);
            margin-bottom: 15px;
            font-size: 1.1em;
            border-bottom: 2px solid var(--color-border);
            padding-bottom: 5px;
        }

        /* Outstanding Question Styling with states */
        .outstanding-question {
            background: rgba(220, 53, 69, 0.1);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid var(--color-progress-red);
            color: var(--color-text-primary);
            transition: all 0.3s ease;
        }

        .outstanding-question.draft {
            background: rgba(253, 126, 20, 0.1);
            border-left-color: var(--color-progress-orange);
        }

        .outstanding-question.final {
            background: rgba(40, 167, 69, 0.1);
            border-left-color: var(--color-progress-green);
        }

        .outstanding-question .question-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .outstanding-question .warning-icon {
            color: var(--color-progress-red);
            margin-right: 8px;
            font-size: 1.1em;
        }

        .outstanding-question.draft .warning-icon {
            color: var(--color-progress-orange);
        }

        .outstanding-question.final .warning-icon {
            color: var(--color-progress-green);
        }

        .outstanding-question strong {
            color: var(--color-text-primary);
        }

        .outstanding-question ul {
            color: var(--color-text-secondary);
        }

        /* Regular established facts/current state */
        .current-state {
            background: rgba(40, 167, 69, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid var(--color-progress-green);
            color: var(--color-text-primary);
        }

        .phase-item {
            background: var(--color-bg-surface);
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid var(--color-accent);
            color: var(--color-text-primary);
        }

        .phase-item h4 {
            color: var(--color-text-primary);
            margin-bottom: 10px;
        }

        .success-metric {
            background: rgba(40, 167, 69, 0.1);
            padding: 10px 15px;
            margin: 8px 0;
            border-radius: 5px;
            border-left: 3px solid var(--color-progress-green);
            color: var(--color-text-primary);
        }

        /* Edit Mode Styles */
        .answer-input {
            width: 100%;
            min-height: 80px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--color-border);
            border-radius: 5px;
            font-family: inherit;
            font-size: 0.9em;
            resize: vertical;
            display: none;
            background: var(--color-bg-primary);
            color: var(--color-text-primary);
        }

        .edit-mode .answer-input {
            display: block;
        }

        /* Draft/Final Toggle */
        .answer-status {
            display: none;
            margin-top: 10px;
            align-items: center;
            gap: 10px;
        }

        .edit-mode .answer-status {
            display: flex;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--color-progress-orange);
            transition: .4s;
            border-radius: 28px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--color-progress-green);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(32px);
        }

        .toggle-label {
            color: var(--color-text-secondary);
            font-size: 0.9em;
        }

        ul, ol {
            padding-left: 25px;
            margin: 15px 0;
        }

        li {
            margin: 8px 0;
        }

        .scroll-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--color-accent);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            opacity: 0;
            visibility: hidden;
        }

        .scroll-top.visible {
            opacity: 1;
            visibility: visible;
        }

        .scroll-top:hover {
            background: var(--color-accent-hover);
            transform: translateY(-2px);
        }

        /* Completion badge */
        .completion-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
            font-weight: normal;
            background: rgba(255,255,255,0.1);
        }

        /* Progress Summary */
        .progress-summary {
            background: var(--color-bg-surface);
            padding: 20px;
            margin: 20px 40px;
            border-radius: 10px;
            border: 1px solid var(--color-border);
            display: none;
        }

        .edit-mode .progress-summary {
            display: block;
        }

        .progress-summary h3 {
            color: var(--color-text-primary);
            margin-bottom: 15px;
        }

        .progress-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            color: var(--color-text-secondary);
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .header {
                padding: 30px 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .header .meta {
                flex-direction: column;
                gap: 10px;
            }
            
            .accordion {
                padding: 0 20px 30px 20px;
            }
            
            .executive-summary {
                padding: 30px 20px;
            }

            .controls {
                padding: 15px 20px;
            }

            .controls-left, .controls-right {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
    <script type="module" src="supabaseClient.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Advanced Engineering & Performance</h1>
            <div class="subtitle">Carbon Robotics LaserWeeder Platform</div>
            <div class="meta">
                <div>Document Version: 2.0</div>
                <div>Date: 2025-07-01</div>
                <div>Status: Streamlined for Team Discussion</div>
            </div>
        </div>

        <div class="controls">
            <div class="controls-left">
                <button class="edit-toggle" onclick="toggleEditMode()">📝 Enable Interactive Mode</button>
                <button class="save-btn" onclick="saveAnswers()">💾 Save Answers</button>
            </div>
            <div class="controls-right">
                <span id="connection-status" style="margin-right: 10px; font-size: 0.9em; color: var(--color-text-secondary);"></span>
                <button class="export-btn" onclick="exportAnswers()">📥 Export</button>
                <button class="import-btn" onclick="document.getElementById('import-file').click()">📤 Import</button>
                <input type="file" id="import-file" class="import-file" accept=".json" onchange="importAnswers(event)">
            </div>
            <div style="width: 100%; text-align: center; font-size: 0.9em; color: var(--color-text-secondary); margin-top: 10px;">
                ⚠️ = Unanswered • 📝 = Draft • ✅ = Final
            </div>
        </div>

        <div class="progress-summary">
            <h3>Overall Progress Summary</h3>
            <div class="progress-item">
                <span>Total Questions:</span>
                <span id="total-questions">0</span>
            </div>
            <div class="progress-item">
                <span>Unanswered:</span>
                <span id="unanswered-count">0</span>
            </div>
            <div class="progress-item">
                <span>Draft Answers:</span>
                <span id="draft-count">0</span>
            </div>
            <div class="progress-item">
                <span>Final Answers:</span>
                <span id="final-count">0</span>
            </div>
            <div class="progress-item" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--color-border);">
                <span><strong>Overall Completion:</strong></span>
                <span><strong id="overall-completion">0%</strong></span>
            </div>
        </div>

        <div class="executive-summary">
            <h2>Executive Summary</h2>
            <p>The Advanced Engineering & Performance team will establish <strong>data-driven performance excellence</strong> across the Carbon Robotics LaserWeeder fleet. This team bridges the gap between technical capability and customer success by defining, measuring, and optimizing the performance relationship between customer expectations and actual machine performance.</p>
            
            <div class="mission-box">
                <strong>Mission:</strong> Transform Carbon Robotics from reactive support to predictive performance optimization through systematic measurement, analysis, and continuous improvement based on field operations and remote visibility.
            </div>
        </div>

        <div class="accordion">
            <!-- Section 1: Performance Standards & Measurement -->
            <div class="accordion-item">
                <button class="accordion-header" data-section="performance-standards">
                    <div class="progress-indicator"></div>
                    <span>1. Performance Standards & Measurement <span class="completion-badge">0%</span></span>
                    <span class="accordion-icon">▼</span>
                </button>
                <div class="accordion-content">
                    <div class="accordion-body">
                        <div class="subsection">
                            <h4>Success Definition & Ownership</h4>
                            
                            <div class="outstanding-question" data-question="customer-success-definition">
                                <div class="question-header">
                                    <span class="warning-icon">⚠️</span>
                                    <strong>Customer Success Definition</strong>
                                </div>
                                What constitutes "successful weeding" from the customer's perspective?
                                <ul>
                                    <li>Weed elimination percentage threshold (e.g., >99% accuracy)</li>
                                    <li>Crop damage tolerance (e.g., <1% crops affected)</li>
                                    <li>Field coverage efficiency (acres/hour based on conditions)</li>
                                </ul>
                                <textarea class="answer-input" placeholder="Enter discussion notes and decisions..."></textarea>
                                <div class="answer-status">
                                    <span class="toggle-label">Draft</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" class="status-toggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="toggle-label">Final</span>
                                </div>
                            </div>

                            <div class="outstanding-question" data-question="performance-ownership">
                                <div class="question-header">
                                    <span class="warning-icon">⚠️</span>
                                    <strong>Performance Standard Ownership</strong>
                                </div>
                                Who defines "good performance" - Carbon or customer?
                                <ul>
                                    <li>How should Carbon establish standard benchmarks?</li>
                                    <li>How do customers define their individual success criteria?</li>
                                    <li>How do we handle conflicting expectations pre/post sale?</li>
                                </ul>
                                <textarea class="answer-input" placeholder="Enter discussion notes and decisions..."></textarea>
                                <div class="answer-status">
                                    <span class="toggle-label">Draft</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" class="status-toggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="toggle-label">Final</span>
                                </div>
                            </div>

                            <div class="outstanding-question" data-question="validation-methods">
                                <div class="question-header">
                                    <span class="warning-icon">⚠️</span>
                                    <strong>Success Validation Methods</strong>
                                </div>
                                How should performance be measured and validated?
                                <ul>
                                    <li>Real-time machine metrics vs. post-field outcome validation</li>
                                    <li>Customer self-reporting vs. Carbon verification</li>
                                    <li>Acceptable deviation thresholds from target performance</li>
                                </ul>
                                <textarea class="answer-input" placeholder="Enter discussion notes and decisions..."></textarea>
                                <div class="answer-status">
                                    <span class="toggle-label">Draft</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" class="status-toggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="toggle-label">Final</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 2: Configuration & Customer Experience -->
            <div class="accordion-item">
                <button class="accordion-header" data-section="configuration-experience">
                    <div class="progress-indicator"></div>
                    <span>2. Configuration & Customer Experience <span class="completion-badge">0%</span></span>
                    <span class="accordion-icon">▼</span>
                </button>
                <div class="accordion-content">
                    <div class="accordion-body">
                        <div class="subsection">
                            <h4>Current Configuration Complexity</h4>
                            
                            <div class="current-state">
                                <strong>✅ Current System Capabilities:</strong><br>
                                The LaserWeeder has numerous configuration parameters:
                                <ul>
                                    <li>DeepWeed model thresholds and WPT vs. CPT confidence levels</li>
                                    <li>P2P health and performance accuracy settings</li>
                                    <li>Scanner health and settle times</li>
                                    <li>Laser firing profiles based on field conditions</li>
                                </ul>
                            </div>

                            <div class="outstanding-question" data-question="configuration-simplification">
                                <div class="question-header">
                                    <span class="warning-icon">⚠️</span>
                                    <strong>Configuration Simplification Strategy</strong>
                                </div>
                                How complex should configuration be for customers?
                                <ul>
                                    <li>What should be "plug-and-play" vs. customer-configurable?</li>
                                    <li>What technical expertise level should we assume?</li>
                                    <li>How quickly should customers reach optimal settings?</li>
                                </ul>
                                <textarea class="answer-input" placeholder="Enter discussion notes and decisions..."></textarea>
                                <div class="answer-status">
                                    <span class="toggle-label">Draft</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" class="status-toggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="toggle-label">Final</span>
                                </div>
                            </div>

                            <div class="outstanding-question" data-question="feedback-mechanisms">
                                <div class="question-header">
                                    <span class="warning-icon">⚠️</span>
                                    <strong>Performance Feedback & Guidance</strong>
                                </div>
                                How do customers know when settings need adjustment?
                                <ul>
                                    <li>Real-time performance scoring and alerts</li>
                                    <li>Early warning indicators for Carbon intervention</li>
                                    <li>Guidance tools for optimization</li>
                                </ul>
                                <textarea class="answer-input" placeholder="Enter discussion notes and decisions..."></textarea>
                                <div class="answer-status">
                                    <span class="toggle-label">Draft</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" class="status-toggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="toggle-label">Final</span>
                                </div>
                            </div>

                            <div class="outstanding-question" data-question="planning-tools">
                                <div class="question-header">
                                    <span class="warning-icon">⚠️</span>
                                    <strong>Job Planning & Prediction Tools</strong>
                                </div>
                                What planning capabilities should we provide?
                                <ul>
                                    <li>Entry timing evaluations for field planning</li>
                                    <li>Job performance predictions and confidence levels</li>
                                    <li>Coverage visualization and optimization</li>
                                </ul>
                                <textarea class="answer-input" placeholder="Enter discussion notes and decisions..."></textarea>
                                <div class="answer-status">
                                    <span class="toggle-label">Draft</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" class="status-toggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="toggle-label">Final</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 3: Monitoring & Proactive Intervention -->
            <div class="accordion-item">
                <button class="accordion-header" data-section="monitoring-intervention">
                    <div class="progress-indicator"></div>
                    <span>3. Monitoring & Proactive Intervention <span class="completion-badge">0%</span></span>
                    <span class="accordion-icon">▼</span>
                </button>
                <div class="accordion-content">
                    <div class="accordion-body">
                        <div class="subsection">
                            <h4>Current Monitoring Infrastructure</h4>
                            
                            <div class="current-state">
                                <strong>✅ Real-time Monitoring Capabilities:</strong><br>
                                Comprehensive monitoring through Prometheus/Grafana:
                                <ul>
                                    <li><strong>Laser/Scanner:</strong> Utilization %, overhead times, error rates</li>
                                    <li><strong>Computer Vision:</strong> DeepWeed accuracy, model confidence, P2P accuracy</li>
                                    <li><strong>Mechanical:</strong> Scanner accuracy, positioning errors, camera health</li>
                                    <li><strong>Remote Alerting:</strong> Semi-reliable alarms and custom dashboards</li>
                                </ul>
                            </div>

                            <div class="outstanding-question" data-question="intervention-strategy">
                                <div class="question-header">
                                    <span class="warning-icon">⚠️</span>
                                    <strong>Proactive Intervention Strategy</strong>
                                </div>
                                When and how should Carbon intervene proactively?
                                <ul>
                                    <li>Performance deviation triggers for automatic alerts</li>
                                    <li>Escalation procedures: automatic vs. recommended vs. manual</li>
                                    <li>Balance between customer autonomy and proactive support</li>
                                </ul>
                                <textarea class="answer-input" placeholder="Enter discussion notes and decisions..."></textarea>
                                <div class="answer-status">
                                    <span class="toggle-label">Draft</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" class="status-toggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="toggle-label">Final</span>
                                </div>
                            </div>

                            <div class="outstanding-question" data-question="monitoring-granularity">
                                <div class="question-header">
                                    <span class="warning-icon">⚠️</span>
                                    <strong>Monitoring Scope & Timing</strong>
                                </div>
                                How should fleet-wide performance monitoring work?
                                <ul>
                                    <li>Real-time vs. daily vs. weekly vs. event-driven monitoring</li>
                                    <li>Fleet-wide performance variation tracking</li>
                                    <li>Immediate vs. trend-based analysis requirements</li>
                                </ul>
                                <textarea class="answer-input" placeholder="Enter discussion notes and decisions..."></textarea>
                                <div class="answer-status">
                                    <span class="toggle-label">Draft</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" class="status-toggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="toggle-label">Final</span>
                                </div>
                            </div>

                            <div class="outstanding-question" data-question="response-model">
                                <div class="question-header">
                                    <span class="warning-icon">⚠️</span>
                                    <strong>Support Response Framework</strong>
                                </div>
                                How should Carbon's support response work?
                                <ul>
                                    <li>When to initiate contact vs. wait for customer issues</li>
                                    <li>Performance degradation patterns requiring immediate action</li>
                                    <li>Measuring intervention effectiveness</li>
                                </ul>
                                <textarea class="answer-input" placeholder="Enter discussion notes and decisions..."></textarea>
                                <div class="answer-status">
                                    <span class="toggle-label">Draft</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" class="status-toggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="toggle-label">Final</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 4: Responsibility & Ownership Framework -->
            <div class="accordion-item">
                <button class="accordion-header" data-section="responsibility-framework">
                    <div class="progress-indicator"></div>
                    <span>4. Responsibility & Ownership Framework <span class="completion-badge">0%</span></span>
                    <span class="accordion-icon">▼</span>
                </button>
                <div class="accordion-content">
                    <div class="accordion-body">
                        <div class="subsection">
                            <h4>Ownership Boundaries</h4>

                            <div class="outstanding-question" data-question="customer-ownership">
                                <div class="question-header">
                                    <span class="warning-icon">⚠️</span>
                                    <strong>Customer Sole Responsibility</strong>
                                </div>
                                What should customers be fully responsible for?
                                <ul>
                                    <li>Field preparation and planning</li>
                                    <li>Basic maintenance and cleaning</li>
                                    <li>Initial configuration parameter selection</li>
                                    <li>Performance expectation setting</li>
                                </ul>
                                <textarea class="answer-input" placeholder="Enter discussion notes and decisions..."></textarea>
                                <div class="answer-status">
                                    <span class="toggle-label">Draft</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" class="status-toggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="toggle-label">Final</span>
                                </div>
                            </div>

                            <div class="outstanding-question" data-question="carbon-ownership">
                                <div class="question-header">
                                    <span class="warning-icon">⚠️</span>
                                    <strong>Carbon Sole Responsibility</strong>
                                </div>
                                What should Carbon be fully responsible for?
                                <ul>
                                    <li>Software updates and bug fixes</li>
                                    <li>Hardware reliability and warranty</li>
                                    <li>Algorithm accuracy and model performance</li>
                                    <li>Technical support for performance issues</li>
                                </ul>
                                <textarea class="answer-input" placeholder="Enter discussion notes and decisions..."></textarea>
                                <div class="answer-status">
                                    <span class="toggle-label">Draft</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" class="status-toggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="toggle-label">Final</span>
                                </div>
                            </div>

                            <div class="outstanding-question" data-question="shared-ownership">
                                <div class="question-header">
                                    <span class="warning-icon">⚠️</span>
                                    <strong>Collaborative Ownership</strong>
                                </div>
                                What requires joint Carbon-Customer ownership?
                                <ul>
                                    <li>Performance optimization and tuning</li>
                                    <li>Field condition adaptation</li>
                                    <li>Success metric definition and measurement</li>
                                    <li>Training and knowledge transfer</li>
                                </ul>
                                <textarea class="answer-input" placeholder="Enter discussion notes and decisions..."></textarea>
                                <div class="answer-status">
                                    <span class="toggle-label">Draft</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" class="status-toggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="toggle-label">Final</span>
                                </div>
                            </div>

                            <div class="outstanding-question" data-question="accountability">
                                <div class="question-header">
                                    <span class="warning-icon">⚠️</span>
                                    <strong>Performance Accountability</strong>
                                </div>
                                How do we handle performance disputes and continuous improvement?
                                <ul>
                                    <li>Root cause ownership determination when performance falls short</li>
                                    <li>SLA formalization between Carbon and customers</li>
                                    <li>Continuous improvement prioritization across customer base</li>
                                </ul>
                                <textarea class="answer-input" placeholder="Enter discussion notes and decisions..."></textarea>
                                <div class="answer-status">
                                    <span class="toggle-label">Draft</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" class="status-toggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="toggle-label">Final</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 5: Technical Implementation -->
            <div class="accordion-item">
                <button class="accordion-header" data-section="technical-implementation">
                    <div class="progress-indicator"></div>
                    <span>5. Technical Implementation & Team Structure <span class="completion-badge">0%</span></span>
                    <span class="accordion-icon">▼</span>
                </button>
                <div class="accordion-content">
                    <div class="accordion-body">
                        <div class="subsection">
                            <h4>Current vs. Required Capabilities</h4>
                            
                            <div class="current-state">
                                <strong>✅ Ready for Implementation:</strong>
                                <ul>
                                    <li>Comprehensive sensor/system data with real-time collection</li>
                                    <li>Grafana monitoring stack operational (needs verification)</li>
                                    <li>Ground truth validation framework established</li>
                                    <li>Multi-layered data architecture for performance correlation</li>
                                </ul>
                            </div>

                            <div class="outstanding-question" data-question="development-priorities">
                                <div class="question-header">
                                    <span class="warning-icon">⚠️</span>
                                    <strong>Development Priorities</strong>
                                </div>
                                What technical capabilities need development?
                                <ul>
                                    <li>Automated performance scoring algorithms</li>
                                    <li>Customer-facing configuration management tools</li>
                                    <li>Predictive analytics for proactive intervention</li>
                                    <li>Standardized performance benchmarking framework</li>
                                </ul>
                                <textarea class="answer-input" placeholder="Enter discussion notes and decisions..."></textarea>
                                <div class="answer-status">
                                    <span class="toggle-label">Draft</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" class="status-toggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="toggle-label">Final</span>
                                </div>
                            </div>
                        </div>

                        <div class="subsection">
                            <h4>AEP Team Structure</h4>
                            
                            <div class="phase-item">
                                <strong>Recommended Team Composition:</strong>
                                <ul>
                                    <li><strong>Performance Engineering Lead</strong> - Systems analysis and optimization</li>
                                    <li><strong>Customer Success Engineering</strong> - Configuration management and support</li>
                                    <li><strong>Data Analytics Specialist</strong> - Performance metrics and insights</li>
                                    <li><strong>Field Application Engineer</strong> - Customer interface and validation</li>
                                </ul>
                            </div>

                            <div style="background: rgba(40, 167, 69, 0.1); padding: 20px; border-radius: 8px; margin: 15px 0;">
                                <strong>Success Metrics for AEP Team:</strong>
                                <div class="success-metric"><strong>Customer Performance Satisfaction:</strong> >95% meeting stated objectives</div>
                                <div class="success-metric"><strong>Configuration Success Rate:</strong> <15min time-to-optimal-settings</div>
                                <div class="success-metric"><strong>Proactive Issue Resolution:</strong> >80% issues resolved before customer impact</div>
                                <div class="success-metric"><strong>Fleet Performance Optimization:</strong> Year-over-year improvement tracking</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 6: Implementation Roadmap -->
            <div class="accordion-item">
                <button class="accordion-header" data-section="implementation-roadmap">
                    <div class="progress-indicator"></div>
                    <span>6. Implementation Roadmap & Next Steps <span class="completion-badge">0%</span></span>
                    <span class="accordion-icon">▼</span>
                </button>
                <div class="accordion-content">
                    <div class="accordion-body">
                        <div class="phase-item">
                            <h4>Phase 1: Foundation (30 days)</h4>
                            <ul>
                                <li><strong>Team Workshop:</strong> Resolve outstanding questions from this document</li>
                                <li><strong>Baseline Assessment:</strong> Current performance capabilities and limitations</li>
                                <li><strong>Customer Research:</strong> Validate performance expectations using known blueprint for success across various customers</li>
                            </ul>
                        </div>

                        <div class="phase-item">
                            <h4>Phase 2: Framework Development (60 days)</h4>
                            <ul>
                                <li><strong>Performance Scoring:</strong> Automated assessment algorithms</li>
                                <li><strong>Configuration Tools:</strong> Customer-facing optimization interfaces</li>
                                <li><strong>Intervention Protocols:</strong> Escalation procedures and automation</li>
                            </ul>
                        </div>

                        <div class="phase-item">
                            <h4>Phase 3: Optimization & Scale (60-180 days)</h4>
                            <ul>
                                <li><strong>Predictive Analytics:</strong> Performance prediction capabilities</li>
                                <li><strong>Continuous Improvement:</strong> Fleet-wide optimization insights</li>
                                <li><strong>Customer Autonomy:</strong> Self-service performance management</li>
                            </ul>
                        </div>

                        <div style="background: rgba(220, 53, 69, 0.1); padding: 20px; border-radius: 10px; margin-top: 20px; border-left: 5px solid var(--color-progress-red);">
                            <h4>⚠️ Immediate Actions Required:</h4>
                            <ol>
                                <li><strong>Team Workshop:</strong> Schedule session to address outstanding questions</li>
                                <li><strong>Customer Investigation:</strong> Interview customers about performance expectations</li>
                                <li><strong>Technical Deep Dive:</strong> Map monitoring capabilities to required metrics</li>
                                <li><strong>Pilot Selection:</strong> Choose test customers for framework validation</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button class="scroll-top" onclick="scrollToTop()">↑</button>

    <script type="module">
        import { supabase } from './supabaseClient.js';
        
        let editMode = false;

        // Initialize completion tracking with weighted calculation
        function updateCompletionStatus() {
            let totalQuestions = 0;
            let unansweredCount = 0;
            let draftCount = 0;
            let finalCount = 0;
            let overallScore = 0;

            document.querySelectorAll('.accordion-header').forEach(header => {
                const section = header.parentElement;
                const questions = section.querySelectorAll('.outstanding-question');
                let sectionScore = 0;
                
                questions.forEach(question => {
                    totalQuestions++;
                    
                    if (question.classList.contains('final')) {
                        finalCount++;
                        sectionScore += 1;
                        overallScore += 1;
                    } else if (question.classList.contains('draft')) {
                        draftCount++;
                        sectionScore += 0.5;
                        overallScore += 0.5;
                    } else {
                        unansweredCount++;
                    }
                });
                
                const percentage = questions.length > 0 ? Math.round((sectionScore / questions.length) * 100) : 0;
                
                // Update badge text
                const badge = header.querySelector('.completion-badge');
                if (badge) {
                    badge.textContent = `${percentage}%`;
                }
                
                // Update progress indicator color
                const progressIndicator = header.querySelector('.progress-indicator');
                if (progressIndicator) {
                    // Remove all progress classes
                    progressIndicator.classList.remove('progress-0', 'progress-25', 'progress-50', 'progress-75', 'progress-100');
                    
                    // Add appropriate class based on percentage
                    if (percentage === 0) {
                        progressIndicator.classList.add('progress-0');
                    } else if (percentage < 25) {
                        progressIndicator.classList.add('progress-25');
                    } else if (percentage < 50) {
                        progressIndicator.classList.add('progress-50');
                    } else if (percentage < 100) {
                        progressIndicator.classList.add('progress-75');
                    } else {
                        progressIndicator.classList.add('progress-100');
                    }
                }
            });

            // Update summary counts
            document.getElementById('total-questions').textContent = totalQuestions;
            document.getElementById('unanswered-count').textContent = unansweredCount;
            document.getElementById('draft-count').textContent = draftCount;
            document.getElementById('final-count').textContent = finalCount;
            
            const overallPercentage = totalQuestions > 0 ? Math.round((overallScore / totalQuestions) * 100) : 0;
            document.getElementById('overall-completion').textContent = `${overallPercentage}%`;
        }

        // Accordion functionality - allows multiple open
        function initializeAccordion() {
            const accordionHeaders = document.querySelectorAll('.accordion-header');
            
            accordionHeaders.forEach(header => {
                header.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    const content = header.nextElementSibling;
                    const isActive = header.classList.contains('active');
                    
                    // Simply toggle the current accordion
                    if (isActive) {
                        header.classList.remove('active');
                        content.classList.remove('active');
                    } else {
                        header.classList.add('active');
                        content.classList.add('active');
                    }
                });
            });
        }

        // Edit mode functionality
        function toggleEditMode() {
            editMode = !editMode;
            const body = document.body;
            const toggleBtn = document.querySelector('.edit-toggle');
            const saveBtn = document.querySelector('.save-btn');
            const exportBtn = document.querySelector('.export-btn');
            const importBtn = document.querySelector('.import-btn');
            
            if (editMode) {
                body.classList.add('edit-mode');
                toggleBtn.textContent = '👁️ View Mode';
                toggleBtn.classList.add('active');
                saveBtn.style.display = 'inline-block';
                exportBtn.style.display = 'inline-block';
                importBtn.style.display = 'inline-block';
            } else {
                body.classList.remove('edit-mode');
                toggleBtn.textContent = '📝 Enable Interactive Mode';
                toggleBtn.classList.remove('active');
                saveBtn.style.display = 'none';
                exportBtn.style.display = 'none';
                importBtn.style.display = 'none';
            }
        }

        // Export/Import functionality
        async function exportAnswers() {
            try {
                const { data: rows, error } = await supabase.from('answers').select();
                if (error) throw error;
                
                if (!rows || rows.length === 0) {
                    alert('No answers to export');
                    return;
                }
                
                // Convert to original format for compatibility
                const answers = {};
                rows.forEach(row => {
                    if (row.text) {
                        answers[row.id] = {
                            text: row.text,
                            status: row.status
                        };
                    }
                });
                
                const data = {
                    version: '2.0',
                    exportDate: new Date().toISOString(),
                    documentTitle: 'Advanced Engineering & Performance Team Scope',
                    answers: answers
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `aep-answers-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Export error:', error);
                alert('Failed to export answers. Please try again.');
            }
        }

        async function importAnswers(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (!data.answers || !data.version) {
                        alert('Invalid file format');
                        return;
                    }
                    
                    if (confirm('This will overwrite your current answers. Continue?')) {
                        // Convert old format to new format
                        const updates = Object.entries(data.answers).map(([id, answerData]) => ({
                            id,
                            text: answerData.text || '',
                            status: answerData.status || 'draft',
                            updated_at: new Date().toISOString()
                        }));
                        
                        // Batch upsert
                        const { error } = await supabase.from('answers').upsert(updates);
                        if (error) throw error;
                        
                        alert('Answers imported successfully!');
                        // Reload to show imported data
                        location.reload();
                    }
                } catch (error) {
                    alert('Error importing file: ' + error.message);
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
            
            // Clear the input for future imports
            event.target.value = '';
        }

        // Scroll to top functionality
        function initializeScrollTop() {
            const scrollTopBtn = document.querySelector('.scroll-top');
            
            window.addEventListener('scroll', () => {
                if (window.pageYOffset > 300) {
                    scrollTopBtn.classList.add('visible');
                } else {
                    scrollTopBtn.classList.remove('visible');
                }
            });
        }

        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        /* ---------- Supabase Integration ---------- */
        
        // Save helper with debounce
        const save = _.debounce(async (id, text, status) => {
            try {
                await supabase.from('answers').upsert({ 
                    id, 
                    text, 
                    status,
                    updated_at: new Date().toISOString()
                });
                
                // Show save confirmation
                const saveBtn = document.querySelector('.save-btn');
                if (saveBtn) {
                    const originalText = saveBtn.textContent;
                    saveBtn.textContent = '✓ Saved!';
                    setTimeout(() => {
                        saveBtn.textContent = originalText;
                    }, 2000);
                }
            } catch (error) {
                console.error('Save error:', error);
                
                // Check if offline
                if (!navigator.onLine) {
                    alert('You appear to be offline. Changes will not be saved until connection is restored.');
                } else {
                    alert('Failed to save. Please check your connection.');
                }
            }
        }, 500);
        
        // Initialize auth and load data
        async function initializeSupabase() {
            const statusEl = document.getElementById('connection-status');
            
            try {
                // Update status
                if (statusEl) statusEl.textContent = '🔄 Connecting...';
                
                // Check if we're coming back from OAuth redirect
                const hashParams = new URLSearchParams(window.location.hash.substring(1));
                const accessToken = hashParams.get('access_token');
                
                if (accessToken) {
                    // Wait a moment for Supabase to process the OAuth callback
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    // Clean up the URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
                
                // Check session
                let { data: { session }, error: sessionError } = await supabase.auth.getSession();
                
                if (sessionError) {
                    console.error('Session error:', sessionError);
                    if (statusEl) statusEl.textContent = '🔴 Session error';
                    return;
                }
                
                if (!session) {
                    // Check if we're already in the process of redirecting
                    const isRedirecting = sessionStorage.getItem('oauth_redirecting');
                    if (isRedirecting) {
                        console.log('Already redirecting, waiting...');
                        sessionStorage.removeItem('oauth_redirecting');
                        return;
                    }
                    
                    if (statusEl) statusEl.textContent = '🔐 Redirecting to login...';
                    sessionStorage.setItem('oauth_redirecting', 'true');
                    
                    const { error: signInError } = await supabase.auth.signInWithOAuth({ 
                        provider: 'google', 
                        options: { 
                            redirectTo: window.location.origin + window.location.pathname,
                            scopes: 'email'
                        } 
                    });
                    
                    if (signInError) {
                        console.error('Sign in error:', signInError);
                        sessionStorage.removeItem('oauth_redirecting');
                        if (statusEl) statusEl.textContent = '🔴 Sign in failed';
                    }
                    return; // Will redirect
                }
                
                // Show user email with sign out link
                if (statusEl) {
                    statusEl.innerHTML = `🟢 Connected as ${session.user.email} <a href="#" onclick="signOut(); return false;" style="color: var(--color-accent); text-decoration: underline;">Sign out</a>`;
                }
                
                // Load initial data
                const { data: rows, error } = await supabase.from('answers').select();
                if (error) throw error;
                
                rows?.forEach(r => {
                    const q = document.querySelector(`[data-question="${r.id}"]`);
                    if (!q) return;
                    const ta = q.querySelector('.answer-input');
                    const toggle = q.querySelector('.status-toggle');
                    
                    if (ta) ta.value = r.text || '';
                    
                    // Update status and styling
                    q.classList.remove('draft', 'final');
                    if (r.status === 'draft') {
                        q.classList.add('draft');
                        if (toggle) toggle.checked = false;
                        const icon = q.querySelector('.warning-icon');
                        if (icon) icon.textContent = '📝';
                    } else if (r.status === 'final') {
                        q.classList.add('final');
                        if (toggle) toggle.checked = true;
                        const icon = q.querySelector('.warning-icon');
                        if (icon) icon.textContent = '✅';
                    }
                });
                
                updateCompletionStatus();
                
                // Subscribe to realtime updates
                supabase.channel('answers')
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'answers' },
                        ({ new: r }) => {
                            const q = document.querySelector(`[data-question="${r.id}"]`);
                            if (!q) return;
                            const ta = q.querySelector('.answer-input');
                            if (ta && ta.value !== r.text) {
                                ta.value = r.text || '';
                                
                                // Update visual state
                                const toggle = q.querySelector('.status-toggle');
                                q.classList.remove('draft', 'final');
                                if (r.status === 'draft') {
                                    q.classList.add('draft');
                                    if (toggle) toggle.checked = false;
                                    const icon = q.querySelector('.warning-icon');
                                    if (icon) icon.textContent = '📝';
                                } else if (r.status === 'final') {
                                    q.classList.add('final');
                                    if (toggle) toggle.checked = true;
                                    const icon = q.querySelector('.warning-icon');
                                    if (icon) icon.textContent = '✅';
                                }
                                
                                updateCompletionStatus();
                            }
                        }
                    )
                    .subscribe();
                    
                // Hook up event listeners for saving
                document.querySelectorAll('.outstanding-question').forEach(q => {
                    const id = q.dataset.question;
                    const ta = q.querySelector('.answer-input');
                    const toggle = q.querySelector('.status-toggle');
                    
                    if (ta) {
                        ta.addEventListener('input', () => {
                            const status = toggle?.checked ? 'final' : 'draft';
                            save(id, ta.value, status);
                            
                            // Update visual state immediately
                            q.classList.remove('draft', 'final');
                            q.classList.add(status);
                            const icon = q.querySelector('.warning-icon');
                            if (icon) icon.textContent = status === 'final' ? '✅' : '📝';
                            updateCompletionStatus();
                        });
                    }
                    
                    if (toggle) {
                        toggle.addEventListener('change', () => {
                            const status = toggle.checked ? 'final' : 'draft';
                            save(id, ta?.value || '', status);
                            
                            // Update visual state immediately
                            q.classList.remove('draft', 'final');
                            q.classList.add(status);
                            const icon = q.querySelector('.warning-icon');
                            if (icon) icon.textContent = status === 'final' ? '✅' : '📝';
                            updateCompletionStatus();
                        });
                    }
                });
                
            } catch (error) {
                console.error('Initialization error:', error);
                if (statusEl) statusEl.textContent = '🔴 Connection failed';
                alert('Failed to connect to database. Please refresh the page.');
            }
        }
        
        // Initialize everything when page loads
        window.addEventListener('load', async () => {
            initializeAccordion();
            initializeScrollTop();
            
            // Set up auth state listener first
            supabase.auth.onAuthStateChange(async (event, session) => {
                console.log('Auth state changed:', event);
                if (event === 'SIGNED_IN' && session) {
                    // User just signed in, reinitialize
                    await initializeSupabase();
                }
            });
            
            // Initialize Supabase connection and auth
            await initializeSupabase();
            
            // All accordions start closed (no auto-expand)
        });
        
        // Sign out function
        async function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                await supabase.auth.signOut();
                location.reload();
            }
        }
        
        // Expose functions to global scope for onclick handlers
        window.toggleEditMode = toggleEditMode;
        window.exportAnswers   = exportAnswers;
        window.importAnswers   = importAnswers;
        window.scrollToTop     = scrollToTop;
        window.signOut         = signOut;
    </script>
</body>
</html>